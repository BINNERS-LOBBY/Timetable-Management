<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Step 3 - Subjects per Class</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .subject-row {
      display: grid;
      grid-template-columns: 1fr 120px 120px 120px 90px;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .autocomplete {
      position: relative;
    }
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .autocomplete-item:hover, .autocomplete-item.active {
      background: #e6f3ff;
    }
    .validation-error {
      background: #fee;
      border: 1px solid #f88;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      color: #c00;
    }
    .validation-summary {
      background: #f0f8ff;
      border: 1px solid #b0d4f1;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <header><h1>Step 3 â€” Subjects per Class</h1></header>
  <main class="card">
    <p>For each class, add subjects and required weekly periods. Mark labs and set lab block size (3 or 4).</p>
    
    {% if validation_errors %}
      <div class="validation-error">
        <h4>âš  Period Allocation Errors:</h4>
        <ul>
          {% for error in validation_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
        <p><strong>Please adjust period allocations before proceeding.</strong></p>
      </div>
    {% endif %}
    
    <div class="validation-summary">
      <h4>ðŸ“Š Quick Validation:</h4>
      <p>Total periods available per class per week: <strong>{{ periods_per_day * 6 }}</strong> ({{ periods_per_day }} periods Ã— 6 days)</p>
      <p>The system will validate your allocations and warn if any class exceeds this limit.</p>
    </div>

    <form id="subjectsForm" method="POST" action="{{ url_for('step3_subjects') }}" onsubmit="prepareAndSubmit(event)">
      {% for cname in class_names %}
        <section class="card">
          <h3>{{ cname }}</h3>
          <div id="container_{{ loop.index0 }}"></div>
          <button type="button" class="btn" data-class-index="{{ loop.index0 }}" onclick="addSubjectRow(this)">+ Add Subject</button>
        </section>
      {% endfor %}

      <input type="hidden" name="subjects_json" id="subjects_json">
      <div class="actions"><button class="btn primary" type="submit">Next â†’ Faculties</button></div>
    </form>
  </main>

  <script>
  const classNames = JSON.parse('{{ class_names|tojson|safe }}');
  const classCount = classNames.length;
  const availableSubjects = {{ available_subjects|tojson|safe }};
  const periodsPerDay = {{ periods_per_day }};
  const maxPeriodsPerWeek = periodsPerDay * 6;
  const subjectDetails = {};
  
  // Populate subject details from database
  availableSubjects.forEach(subject => {
    subjectDetails[subject.name] = {
      periods: subject.default_periods,
      type: subject.default_type,
      lab_block: subject.default_lab_block
    };
  });

  // Add one subject row for each class by default
  for (let i = 0; i < classCount; i++) addSubjectRow(document.querySelector(`[data-class-index="${i}"]`));

  function addSubjectRow(button) {
    const classIdx = button.dataset.classIndex;
    const cont = document.getElementById('container_' + classIdx);
    const id = Math.random().toString(36).slice(2, 9);
    const html = `
      <div class="subject-row" id="row_${classIdx}_${id}">
        <div class="autocomplete">
          <input type="text" class="sub_name" placeholder="Type to search subjects..." 
                 onkeyup="showAutocomplete(this)" onblur="hideAutocomplete(this)" 
                 onfocus="showAutocomplete(this)" onchange="populateSubjectDetails(this)">
          <div class="autocomplete-list" id="autocomplete_${classIdx}_${id}"></div>
        </div>
        <select class="sub_type" onchange="toggleLabBlock(this)">
          <option value="theory">Theory</option>
          <option value="lab">Lab</option>
        </select>
        <input type="number" class="sub_periods" placeholder="Periods" min="1" value="3" onchange="validatePeriods()">
        <select class="sub_lab_block" style="display:none;">
          <option value="3">Block 3</option>
          <option value="4">Block 4</option>
        </select>
        <button type="button" onclick="removeSubject(this)">Remove</button>
      </div>`;
    cont.insertAdjacentHTML('beforeend', html);
    validatePeriods();
  }
  
  function showAutocomplete(input) {
    const value = input.value.toLowerCase();
    const listDiv = input.nextElementSibling;
    const matches = availableSubjects.filter(subject => 
      subject.name.toLowerCase().includes(value)
    ).slice(0, 8);
    
    if (matches.length > 0) {
      listDiv.innerHTML = matches.map(subject => 
        `<div class="autocomplete-item" onclick="selectSubject(this, '${subject.name}')">
          <strong>${subject.name}</strong> 
          <small>(${subject.default_periods}p, ${subject.default_type})</small>
        </div>`
      ).join('');
      listDiv.style.display = 'block';
    } else {
      listDiv.style.display = 'none';
    }
  }
  
  function hideAutocomplete(input) {
    setTimeout(() => {
      input.nextElementSibling.style.display = 'none';
    }, 200);
  }
  
  function selectSubject(item, subjectName) {
    const input = item.parentElement.previousElementSibling;
    input.value = subjectName;
    item.parentElement.style.display = 'none';
    populateSubjectDetails(input);
  }
  
  function removeSubject(button) {
    button.parentElement.remove();
    validatePeriods();
  }
  
  function validatePeriods() {
    for (let i = 0; i < classCount; i++) {
      const container = document.getElementById(`container_${i}`);
      const periodInputs = container.querySelectorAll('.sub_periods');
      let total = 0;
      
      periodInputs.forEach(input => {
        const periods = parseInt(input.value) || 0;
        total += periods;
      });
      
      const className = classNames[i];
      const statusDiv = document.getElementById(`status_${i}`) || createStatusDiv(i, className);
      
      if (total > maxPeriodsPerWeek) {
        statusDiv.innerHTML = `<span style="color: red;">âš  ${total}/${maxPeriodsPerWeek} periods (${total - maxPeriodsPerWeek} excess)</span>`;
        statusDiv.style.color = 'red';
      } else {
        statusDiv.innerHTML = `<span style="color: green;">âœ“ ${total}/${maxPeriodsPerWeek} periods</span>`;
        statusDiv.style.color = 'green';
      }
    }
  }
  
  function createStatusDiv(index, className) {
    const section = document.querySelector(`[data-class-index="${index}"]`).parentElement;
    const h3 = section.querySelector('h3');
    const statusDiv = document.createElement('div');
    statusDiv.id = `status_${index}`;
    statusDiv.style.fontSize = '0.9em';
    statusDiv.style.marginTop = '5px';
    h3.appendChild(statusDiv);
    return statusDiv;
  }

  function populateSubjectDetails(select) {
    const subjectName = select.value;
    const row = select.parentElement;
    if (subjectName === '__new__') {
      row.querySelector('.new_sub_name').style.display = 'block';
      row.querySelector('.new_sub_name').focus();
    } else if (subjectDetails[subjectName]) {
      const details = subjectDetails[subjectName];
      row.querySelector('.new_sub_name').style.display = 'none';
      row.querySelector('.sub_periods').value = details.periods || 3;
      row.querySelector('.sub_type').value = details.type || 'theory';
      toggleLabBlock(row.querySelector('.sub_type'));
      if (details.type === 'lab') {
        row.querySelector('.sub_lab_block').style.display = 'block';
        row.querySelector('.sub_lab_block').value = details.lab_block || 3;
      }
    }
  }

  function addNewSubject(input) {
    const newSubject = input.value.trim();
    if (newSubject) {
      const row = input.parentElement;
      const type = row.querySelector('.sub_type').value;
      const periods = parseInt(row.querySelector('.sub_periods').value, 10);
      const labBlock = type === 'lab' ? parseInt(row.querySelector('.sub_lab_block').value, 10) : null;
      subjectDetails[newSubject] = { periods, type, lab_block: labBlock };
      input.style.display = 'none';
      const select = row.querySelector('.sub_name');
      const newOption = document.createElement('option');
      newOption.value = newSubject;
      newOption.textContent = newSubject;
      select.appendChild(newOption);
      select.value = newSubject;
    }
  }

  function toggleLabBlock(select) {
    const labBlock = select.parentElement.querySelector('.sub_lab_block');
    if (select.value === 'lab') {
      labBlock.style.display = 'block';
    } else {
      labBlock.style.display = 'none';
    }
  }

  function prepareAndSubmit(e) {
    e.preventDefault();
    const data = {};
    for (let i = 0; i < classCount; i++) {
      const rows = document.querySelectorAll(`#container_${i} .subject-row`);
      data[classNames[i]] = Array.from(rows).map((row) => {
        const name = row.querySelector('.sub_name').value;
        const type = row.querySelector('.sub_type').value;
        const periods = parseInt(row.querySelector('.sub_periods').value, 10);
        const labBlock = type === 'lab' ? parseInt(row.querySelector('.sub_lab_block').value, 10) : null;
        return { name, type, periods, lab_block: labBlock };
      });
    }
    document.getElementById('subjects_json').value = JSON.stringify(data);
    document.getElementById('subjectsForm').submit();
  }
  </script>
</body>
</html>
